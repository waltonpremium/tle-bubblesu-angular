/**
 * Created by JohnMak on 28/11/15.
 */

(function ($) {
    // Detect touch support
    $.support.touch = 'ontouchend' in document;
    // Ignore browsers without touch support
    if (!$.support.touch) {
        return;
    }
    var mouseProto = $.ui.mouse.prototype,
        _mouseInit = mouseProto._mouseInit,
        touchHandled;

    function simulateMouseEvent (event, simulatedType) { //use this function to simulate mouse event
        // Ignore multi-touch events
        if (event.originalEvent.touches.length > 1) {
            return;
        }
        event.preventDefault(); //use this to prevent scrolling during ui use

        var touch = event.originalEvent.changedTouches[0],
            simulatedEvent = document.createEvent('MouseEvents');
        // Initialize the simulated mouse event using the touch event's coordinates
        simulatedEvent.initMouseEvent(
            simulatedType,    // type
            true,             // bubbles
            true,             // cancelable
            window,           // view
            1,                // detail
            touch.screenX,    // screenX
            touch.screenY,    // screenY
            touch.clientX,    // clientX
            touch.clientY,    // clientY
            false,            // ctrlKey
            false,            // altKey
            false,            // shiftKey
            false,            // metaKey
            0,                // button
            null              // relatedTarget
        );

        // Dispatch the simulated event to the target element
        event.target.dispatchEvent(simulatedEvent);
    }
    mouseProto._touchStart = function (event) {
        var self = this;
        // Ignore the event if another widget is already being handled
        if (touchHandled || !self._mouseCapture(event.originalEvent.changedTouches[0])) {
            return;
        }
        // Set the flag to prevent other widgets from inheriting the touch event
        touchHandled = true;
        // Track movement to determine if interaction was a click
        self._touchMoved = false;
        // Simulate the mouseover event
        simulateMouseEvent(event, 'mouseover');
        // Simulate the mousemove event
        simulateMouseEvent(event, 'mousemove');
        // Simulate the mousedown event
        simulateMouseEvent(event, 'mousedown');
    };

    mouseProto._touchMove = function (event) {
        // Ignore event if not handled
        if (!touchHandled) {
            return;
        }
        // Interaction was not a click
        this._touchMoved = true;
        // Simulate the mousemove event
        simulateMouseEvent(event, 'mousemove');
    };
    mouseProto._touchEnd = function (event) {
        // Ignore event if not handled
        if (!touchHandled) {
            return;
        }
        // Simulate the mouseup event
        simulateMouseEvent(event, 'mouseup');
        // Simulate the mouseout event
        simulateMouseEvent(event, 'mouseout');
        // If the touch interaction did not move, it should trigger a click
        if (!this._touchMoved) {
            // Simulate the click event
            simulateMouseEvent(event, 'click');
        }
        // Unset the flag to allow other widgets to inherit the touch event
        touchHandled = false;
    };
    mouseProto._mouseInit = function () {
        var self = this;
        // Delegate the touch handlers to the widget's element
        self.element
            .on('touchstart', $.proxy(self, '_touchStart'))
            .on('touchmove', $.proxy(self, '_touchMove'))
            .on('touchend', $.proxy(self, '_touchEnd'));

        // Call the original $.ui.mouse init method
        _mouseInit.call(self);
    };
})(jQuery);
/**
 * Created by JohnMak on 17/12/15.
 */
(function ( $ ) {

    function find_angle(A,B,C) {
        return (Math.atan2(A.y - B.y, A.x - B.x) - Math.atan2(C.y - B.y, C.x - B.x))*180/Math.PI;
    }

    $.fn.touchrotate =  function(params, callback) {

    //// PREPARING PARAMETERS
        var frame = this;

        default_params = {
            handle: $(this),
            subject: $(this).children('div'),
            center_x:50,
            center_y:50
        };

        params = $.extend(true, default_params, params);

        params.handle = $(params.handle);

        var cur_angle = 0;
        var delta_prev_angle = 0;
        var delta_angle = 0;

        var drag_start_coord = {x:0,y:0};
        var obj_center_coord = {
            x:this.offset().left + this.width()*params.center_x/100,
            y:this.offset().top + this.height()*params.center_y/100
        };
        //$('body').append($('.touch_point'));
        //
        //$('#touch_point_center').css('top', obj_center_coord.y).css('left', obj_center_coord.x);

        var jq_body = $('body');


    //// MANIPULATING FUNCTIONS
        function rotate(newAngle) {
            params.subject.css('transform','rotate(' + newAngle + 'deg)');
        }

    //// EVENTS HANDLES

        function dragStart(e){
            bindMove();
            bindStop();
            stopInertia();
            drag_start_coord.x = e.pageX;
            drag_start_coord.y = e.pageY;
            if (typeof e.touches !== 'undefined'){
                drag_start_coord.x = e.touches[0].pageX;
                drag_start_coord.y = e.touches[0].pageY;
            }
            obj_center_coord = {
                x:frame.offset().left + frame.width()*params.center_x/100,
                y:frame.offset().top + frame.height()*params.center_y/100
            };
            delta_prev_angle = 0;
            delta_angle = 0;
            //$('#touch_point_center').css('top', obj_center_coord.y).css('left', obj_center_coord.x);
            //
            //$('#touch_point_start').css('top', drag_start_coord.y).css('left', drag_start_coord.x);
        }

        function dragMove(e){
            var touch_point = {
                x: e.pageX,
                y: e.pageY
            };
            if (typeof e.touches !== 'undefined'){
                touch_point.x = e.touches[0].pageX;
                touch_point.y = e.touches[0].pageY;
            }
            //$('#touch_point_touch').css('top', touch_point.y).css('left', touch_point.x);
            delta_prev_angle = delta_angle;
            delta_angle = find_angle(touch_point, obj_center_coord, drag_start_coord);

            rotate(cur_angle + delta_angle);


            e.stopPropagation();
            e.preventDefault();
        }

        function dragStop(e){
            cur_angle = cur_angle + delta_angle;
            if (callback) callback(cur_angle);
            startInertia(delta_angle-delta_prev_angle);
            unbindMove();
            unbindStop();
        }

        var inertia_interval = false;
        var inertia_power = 0;

        function startInertia(power) {
            inertia_power = power;

            inertia_interval = setInterval(processInertia, 20)
        }
        function processInertia() {
            cur_angle += inertia_power;
            rotate(cur_angle);

            inertia_power /= 1.07;
            if (Math.abs(inertia_power) < .1)
                stopInertia();
        }

        function stopInertia() {
            clearInterval(inertia_interval);
        }


    //// BINDING FUNCTIONS

        function bindStart(){
            params.handle.on('mousedown', dragStart);
            params.handle[0].addEventListener('touchstart', dragStart);
        }

        function unbindStart(){
            params.handle.off('mousedown', dragStart);
            params.handle[0].removeEventListener('touchstart', dragStart);
        }


        function bindMove(){
            jq_body.on('mousemove', dragMove);
            jq_body[0].addEventListener('touchmove', dragMove);
        }

        function unbindMove(){
            jq_body.off('mousemove', dragMove);
            jq_body[0].removeEventListener('touchmove', dragMove);
        }


        function bindStop(){
            jq_body.on('mouseup', dragStop);
            jq_body.on('mouseleave', dragStop);
            jq_body.on('touchend', dragStop);
            jq_body.on('touchcancel', dragStop);
        }

        function unbindStop(){
            jq_body.off('mouseup', dragStop);
            jq_body.off('mouseleave', dragStop);
            jq_body.off('touchend', dragStop);
            jq_body.off('touchcancel', dragStop);
        }



    //// INIT

        bindStart();
    };


}( jQuery ));
/*!
 * Scroll Lock v1.1.1
 * https://github.com/MohammadYounes/jquery-scrollLock
 *
 * Copyright (c) 2014 Mohammad Younes
 * Licensed under the MIT license.
 */
(function(n){typeof define=="function"&&define.amd?define(["jquery"],n):n(jQuery)})(function(n){function u(n){var t=n.prop("clientWidth"),i=n.prop("offsetWidth"),r=parseInt(n.css("border-right-width"),10),u=parseInt(n.css("border-left-width"),10);return t+u+r<i}var i="onmousewheel"in window?"ActiveXObject"in window?"wheel":"mousewheel":"DOMMouseScroll",t=".scrollLock",r=n.fn.scrollLock;n.fn.scrollLock=function(r,f,e){return typeof f!="string"&&(f=null),(r===undefined||r)&&r!=="off"?this.each(function(){n(this).on(i+t,f,function(t){var i,s;if(!t.ctrlKey&&(i=n(this),e===!0||u(i))){t.stopPropagation();var f=i.scrollTop(),h=i.prop("scrollHeight"),c=i.prop("clientHeight"),o=t.originalEvent.wheelDelta||-1*t.originalEvent.detail||-1*t.originalEvent.deltaY,r=0;t.type==="wheel"&&(s=i.height()/n(window).height(),r=t.originalEvent.deltaY*s);(o>0&&f+r<=0||o<0&&f+r>=h-c)&&(t.preventDefault(),r&&i.scrollTop(f+r))}})}):this.each(function(){n(this).off(t)})};n.fn.scrollLock.noConflict=function(){return n.fn.scrollLock=r,this}});
/*
//# sourceMappingURL=jquery-scrollLock.min.js.map
*/
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRvdWNoX3N1cHBvcnQuanMiLCJ0b3VjaHJvdGF0ZS5qcXVlcnkuanMiLCJzY3JvbGxfbG9jay9qcXVlcnktc2Nyb2xsTG9jay5taW4uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0R0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyS0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJzY3JpcHRzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSBKb2huTWFrIG9uIDI4LzExLzE1LlxuICovXG5cbihmdW5jdGlvbiAoJCkge1xuICAgIC8vIERldGVjdCB0b3VjaCBzdXBwb3J0XG4gICAgJC5zdXBwb3J0LnRvdWNoID0gJ29udG91Y2hlbmQnIGluIGRvY3VtZW50O1xuICAgIC8vIElnbm9yZSBicm93c2VycyB3aXRob3V0IHRvdWNoIHN1cHBvcnRcbiAgICBpZiAoISQuc3VwcG9ydC50b3VjaCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBtb3VzZVByb3RvID0gJC51aS5tb3VzZS5wcm90b3R5cGUsXG4gICAgICAgIF9tb3VzZUluaXQgPSBtb3VzZVByb3RvLl9tb3VzZUluaXQsXG4gICAgICAgIHRvdWNoSGFuZGxlZDtcblxuICAgIGZ1bmN0aW9uIHNpbXVsYXRlTW91c2VFdmVudCAoZXZlbnQsIHNpbXVsYXRlZFR5cGUpIHsgLy91c2UgdGhpcyBmdW5jdGlvbiB0byBzaW11bGF0ZSBtb3VzZSBldmVudFxuICAgICAgICAvLyBJZ25vcmUgbXVsdGktdG91Y2ggZXZlbnRzXG4gICAgICAgIGlmIChldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vdXNlIHRoaXMgdG8gcHJldmVudCBzY3JvbGxpbmcgZHVyaW5nIHVpIHVzZVxuXG4gICAgICAgIHZhciB0b3VjaCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0sXG4gICAgICAgICAgICBzaW11bGF0ZWRFdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdNb3VzZUV2ZW50cycpO1xuICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBzaW11bGF0ZWQgbW91c2UgZXZlbnQgdXNpbmcgdGhlIHRvdWNoIGV2ZW50J3MgY29vcmRpbmF0ZXNcbiAgICAgICAgc2ltdWxhdGVkRXZlbnQuaW5pdE1vdXNlRXZlbnQoXG4gICAgICAgICAgICBzaW11bGF0ZWRUeXBlLCAgICAvLyB0eXBlXG4gICAgICAgICAgICB0cnVlLCAgICAgICAgICAgICAvLyBidWJibGVzXG4gICAgICAgICAgICB0cnVlLCAgICAgICAgICAgICAvLyBjYW5jZWxhYmxlXG4gICAgICAgICAgICB3aW5kb3csICAgICAgICAgICAvLyB2aWV3XG4gICAgICAgICAgICAxLCAgICAgICAgICAgICAgICAvLyBkZXRhaWxcbiAgICAgICAgICAgIHRvdWNoLnNjcmVlblgsICAgIC8vIHNjcmVlblhcbiAgICAgICAgICAgIHRvdWNoLnNjcmVlblksICAgIC8vIHNjcmVlbllcbiAgICAgICAgICAgIHRvdWNoLmNsaWVudFgsICAgIC8vIGNsaWVudFhcbiAgICAgICAgICAgIHRvdWNoLmNsaWVudFksICAgIC8vIGNsaWVudFlcbiAgICAgICAgICAgIGZhbHNlLCAgICAgICAgICAgIC8vIGN0cmxLZXlcbiAgICAgICAgICAgIGZhbHNlLCAgICAgICAgICAgIC8vIGFsdEtleVxuICAgICAgICAgICAgZmFsc2UsICAgICAgICAgICAgLy8gc2hpZnRLZXlcbiAgICAgICAgICAgIGZhbHNlLCAgICAgICAgICAgIC8vIG1ldGFLZXlcbiAgICAgICAgICAgIDAsICAgICAgICAgICAgICAgIC8vIGJ1dHRvblxuICAgICAgICAgICAgbnVsbCAgICAgICAgICAgICAgLy8gcmVsYXRlZFRhcmdldFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIERpc3BhdGNoIHRoZSBzaW11bGF0ZWQgZXZlbnQgdG8gdGhlIHRhcmdldCBlbGVtZW50XG4gICAgICAgIGV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KHNpbXVsYXRlZEV2ZW50KTtcbiAgICB9XG4gICAgbW91c2VQcm90by5fdG91Y2hTdGFydCA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIC8vIElnbm9yZSB0aGUgZXZlbnQgaWYgYW5vdGhlciB3aWRnZXQgaXMgYWxyZWFkeSBiZWluZyBoYW5kbGVkXG4gICAgICAgIGlmICh0b3VjaEhhbmRsZWQgfHwgIXNlbGYuX21vdXNlQ2FwdHVyZShldmVudC5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIFNldCB0aGUgZmxhZyB0byBwcmV2ZW50IG90aGVyIHdpZGdldHMgZnJvbSBpbmhlcml0aW5nIHRoZSB0b3VjaCBldmVudFxuICAgICAgICB0b3VjaEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICAvLyBUcmFjayBtb3ZlbWVudCB0byBkZXRlcm1pbmUgaWYgaW50ZXJhY3Rpb24gd2FzIGEgY2xpY2tcbiAgICAgICAgc2VsZi5fdG91Y2hNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAvLyBTaW11bGF0ZSB0aGUgbW91c2VvdmVyIGV2ZW50XG4gICAgICAgIHNpbXVsYXRlTW91c2VFdmVudChldmVudCwgJ21vdXNlb3ZlcicpO1xuICAgICAgICAvLyBTaW11bGF0ZSB0aGUgbW91c2Vtb3ZlIGV2ZW50XG4gICAgICAgIHNpbXVsYXRlTW91c2VFdmVudChldmVudCwgJ21vdXNlbW92ZScpO1xuICAgICAgICAvLyBTaW11bGF0ZSB0aGUgbW91c2Vkb3duIGV2ZW50XG4gICAgICAgIHNpbXVsYXRlTW91c2VFdmVudChldmVudCwgJ21vdXNlZG93bicpO1xuICAgIH07XG5cbiAgICBtb3VzZVByb3RvLl90b3VjaE1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgLy8gSWdub3JlIGV2ZW50IGlmIG5vdCBoYW5kbGVkXG4gICAgICAgIGlmICghdG91Y2hIYW5kbGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gSW50ZXJhY3Rpb24gd2FzIG5vdCBhIGNsaWNrXG4gICAgICAgIHRoaXMuX3RvdWNoTW92ZWQgPSB0cnVlO1xuICAgICAgICAvLyBTaW11bGF0ZSB0aGUgbW91c2Vtb3ZlIGV2ZW50XG4gICAgICAgIHNpbXVsYXRlTW91c2VFdmVudChldmVudCwgJ21vdXNlbW92ZScpO1xuICAgIH07XG4gICAgbW91c2VQcm90by5fdG91Y2hFbmQgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgLy8gSWdub3JlIGV2ZW50IGlmIG5vdCBoYW5kbGVkXG4gICAgICAgIGlmICghdG91Y2hIYW5kbGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gU2ltdWxhdGUgdGhlIG1vdXNldXAgZXZlbnRcbiAgICAgICAgc2ltdWxhdGVNb3VzZUV2ZW50KGV2ZW50LCAnbW91c2V1cCcpO1xuICAgICAgICAvLyBTaW11bGF0ZSB0aGUgbW91c2VvdXQgZXZlbnRcbiAgICAgICAgc2ltdWxhdGVNb3VzZUV2ZW50KGV2ZW50LCAnbW91c2VvdXQnKTtcbiAgICAgICAgLy8gSWYgdGhlIHRvdWNoIGludGVyYWN0aW9uIGRpZCBub3QgbW92ZSwgaXQgc2hvdWxkIHRyaWdnZXIgYSBjbGlja1xuICAgICAgICBpZiAoIXRoaXMuX3RvdWNoTW92ZWQpIHtcbiAgICAgICAgICAgIC8vIFNpbXVsYXRlIHRoZSBjbGljayBldmVudFxuICAgICAgICAgICAgc2ltdWxhdGVNb3VzZUV2ZW50KGV2ZW50LCAnY2xpY2snKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBVbnNldCB0aGUgZmxhZyB0byBhbGxvdyBvdGhlciB3aWRnZXRzIHRvIGluaGVyaXQgdGhlIHRvdWNoIGV2ZW50XG4gICAgICAgIHRvdWNoSGFuZGxlZCA9IGZhbHNlO1xuICAgIH07XG4gICAgbW91c2VQcm90by5fbW91c2VJbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIC8vIERlbGVnYXRlIHRoZSB0b3VjaCBoYW5kbGVycyB0byB0aGUgd2lkZ2V0J3MgZWxlbWVudFxuICAgICAgICBzZWxmLmVsZW1lbnRcbiAgICAgICAgICAgIC5vbigndG91Y2hzdGFydCcsICQucHJveHkoc2VsZiwgJ190b3VjaFN0YXJ0JykpXG4gICAgICAgICAgICAub24oJ3RvdWNobW92ZScsICQucHJveHkoc2VsZiwgJ190b3VjaE1vdmUnKSlcbiAgICAgICAgICAgIC5vbigndG91Y2hlbmQnLCAkLnByb3h5KHNlbGYsICdfdG91Y2hFbmQnKSk7XG5cbiAgICAgICAgLy8gQ2FsbCB0aGUgb3JpZ2luYWwgJC51aS5tb3VzZSBpbml0IG1ldGhvZFxuICAgICAgICBfbW91c2VJbml0LmNhbGwoc2VsZik7XG4gICAgfTtcbn0pKGpRdWVyeSk7IiwiLyoqXG4gKiBDcmVhdGVkIGJ5IEpvaG5NYWsgb24gMTcvMTIvMTUuXG4gKi9cbihmdW5jdGlvbiAoICQgKSB7XG5cbiAgICBmdW5jdGlvbiBmaW5kX2FuZ2xlKEEsQixDKSB7XG4gICAgICAgIHJldHVybiAoTWF0aC5hdGFuMihBLnkgLSBCLnksIEEueCAtIEIueCkgLSBNYXRoLmF0YW4yKEMueSAtIEIueSwgQy54IC0gQi54KSkqMTgwL01hdGguUEk7XG4gICAgfVxuXG4gICAgJC5mbi50b3VjaHJvdGF0ZSA9ICBmdW5jdGlvbihwYXJhbXMsIGNhbGxiYWNrKSB7XG5cbiAgICAvLy8vIFBSRVBBUklORyBQQVJBTUVURVJTXG4gICAgICAgIHZhciBmcmFtZSA9IHRoaXM7XG5cbiAgICAgICAgZGVmYXVsdF9wYXJhbXMgPSB7XG4gICAgICAgICAgICBoYW5kbGU6ICQodGhpcyksXG4gICAgICAgICAgICBzdWJqZWN0OiAkKHRoaXMpLmNoaWxkcmVuKCdkaXYnKSxcbiAgICAgICAgICAgIGNlbnRlcl94OjUwLFxuICAgICAgICAgICAgY2VudGVyX3k6NTBcbiAgICAgICAgfTtcblxuICAgICAgICBwYXJhbXMgPSAkLmV4dGVuZCh0cnVlLCBkZWZhdWx0X3BhcmFtcywgcGFyYW1zKTtcblxuICAgICAgICBwYXJhbXMuaGFuZGxlID0gJChwYXJhbXMuaGFuZGxlKTtcblxuICAgICAgICB2YXIgY3VyX2FuZ2xlID0gMDtcbiAgICAgICAgdmFyIGRlbHRhX3ByZXZfYW5nbGUgPSAwO1xuICAgICAgICB2YXIgZGVsdGFfYW5nbGUgPSAwO1xuXG4gICAgICAgIHZhciBkcmFnX3N0YXJ0X2Nvb3JkID0ge3g6MCx5OjB9O1xuICAgICAgICB2YXIgb2JqX2NlbnRlcl9jb29yZCA9IHtcbiAgICAgICAgICAgIHg6dGhpcy5vZmZzZXQoKS5sZWZ0ICsgdGhpcy53aWR0aCgpKnBhcmFtcy5jZW50ZXJfeC8xMDAsXG4gICAgICAgICAgICB5OnRoaXMub2Zmc2V0KCkudG9wICsgdGhpcy5oZWlnaHQoKSpwYXJhbXMuY2VudGVyX3kvMTAwXG4gICAgICAgIH07XG4gICAgICAgIC8vJCgnYm9keScpLmFwcGVuZCgkKCcudG91Y2hfcG9pbnQnKSk7XG4gICAgICAgIC8vXG4gICAgICAgIC8vJCgnI3RvdWNoX3BvaW50X2NlbnRlcicpLmNzcygndG9wJywgb2JqX2NlbnRlcl9jb29yZC55KS5jc3MoJ2xlZnQnLCBvYmpfY2VudGVyX2Nvb3JkLngpO1xuXG4gICAgICAgIHZhciBqcV9ib2R5ID0gJCgnYm9keScpO1xuXG5cbiAgICAvLy8vIE1BTklQVUxBVElORyBGVU5DVElPTlNcbiAgICAgICAgZnVuY3Rpb24gcm90YXRlKG5ld0FuZ2xlKSB7XG4gICAgICAgICAgICBwYXJhbXMuc3ViamVjdC5jc3MoJ3RyYW5zZm9ybScsJ3JvdGF0ZSgnICsgbmV3QW5nbGUgKyAnZGVnKScpO1xuICAgICAgICB9XG5cbiAgICAvLy8vIEVWRU5UUyBIQU5ETEVTXG5cbiAgICAgICAgZnVuY3Rpb24gZHJhZ1N0YXJ0KGUpe1xuICAgICAgICAgICAgYmluZE1vdmUoKTtcbiAgICAgICAgICAgIGJpbmRTdG9wKCk7XG4gICAgICAgICAgICBzdG9wSW5lcnRpYSgpO1xuICAgICAgICAgICAgZHJhZ19zdGFydF9jb29yZC54ID0gZS5wYWdlWDtcbiAgICAgICAgICAgIGRyYWdfc3RhcnRfY29vcmQueSA9IGUucGFnZVk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGUudG91Y2hlcyAhPT0gJ3VuZGVmaW5lZCcpe1xuICAgICAgICAgICAgICAgIGRyYWdfc3RhcnRfY29vcmQueCA9IGUudG91Y2hlc1swXS5wYWdlWDtcbiAgICAgICAgICAgICAgICBkcmFnX3N0YXJ0X2Nvb3JkLnkgPSBlLnRvdWNoZXNbMF0ucGFnZVk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvYmpfY2VudGVyX2Nvb3JkID0ge1xuICAgICAgICAgICAgICAgIHg6ZnJhbWUub2Zmc2V0KCkubGVmdCArIGZyYW1lLndpZHRoKCkqcGFyYW1zLmNlbnRlcl94LzEwMCxcbiAgICAgICAgICAgICAgICB5OmZyYW1lLm9mZnNldCgpLnRvcCArIGZyYW1lLmhlaWdodCgpKnBhcmFtcy5jZW50ZXJfeS8xMDBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBkZWx0YV9wcmV2X2FuZ2xlID0gMDtcbiAgICAgICAgICAgIGRlbHRhX2FuZ2xlID0gMDtcbiAgICAgICAgICAgIC8vJCgnI3RvdWNoX3BvaW50X2NlbnRlcicpLmNzcygndG9wJywgb2JqX2NlbnRlcl9jb29yZC55KS5jc3MoJ2xlZnQnLCBvYmpfY2VudGVyX2Nvb3JkLngpO1xuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIC8vJCgnI3RvdWNoX3BvaW50X3N0YXJ0JykuY3NzKCd0b3AnLCBkcmFnX3N0YXJ0X2Nvb3JkLnkpLmNzcygnbGVmdCcsIGRyYWdfc3RhcnRfY29vcmQueCk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBkcmFnTW92ZShlKXtcbiAgICAgICAgICAgIHZhciB0b3VjaF9wb2ludCA9IHtcbiAgICAgICAgICAgICAgICB4OiBlLnBhZ2VYLFxuICAgICAgICAgICAgICAgIHk6IGUucGFnZVlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBpZiAodHlwZW9mIGUudG91Y2hlcyAhPT0gJ3VuZGVmaW5lZCcpe1xuICAgICAgICAgICAgICAgIHRvdWNoX3BvaW50LnggPSBlLnRvdWNoZXNbMF0ucGFnZVg7XG4gICAgICAgICAgICAgICAgdG91Y2hfcG9pbnQueSA9IGUudG91Y2hlc1swXS5wYWdlWTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vJCgnI3RvdWNoX3BvaW50X3RvdWNoJykuY3NzKCd0b3AnLCB0b3VjaF9wb2ludC55KS5jc3MoJ2xlZnQnLCB0b3VjaF9wb2ludC54KTtcbiAgICAgICAgICAgIGRlbHRhX3ByZXZfYW5nbGUgPSBkZWx0YV9hbmdsZTtcbiAgICAgICAgICAgIGRlbHRhX2FuZ2xlID0gZmluZF9hbmdsZSh0b3VjaF9wb2ludCwgb2JqX2NlbnRlcl9jb29yZCwgZHJhZ19zdGFydF9jb29yZCk7XG5cbiAgICAgICAgICAgIHJvdGF0ZShjdXJfYW5nbGUgKyBkZWx0YV9hbmdsZSk7XG5cblxuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGRyYWdTdG9wKGUpe1xuICAgICAgICAgICAgY3VyX2FuZ2xlID0gY3VyX2FuZ2xlICsgZGVsdGFfYW5nbGU7XG4gICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGN1cl9hbmdsZSk7XG4gICAgICAgICAgICBzdGFydEluZXJ0aWEoZGVsdGFfYW5nbGUtZGVsdGFfcHJldl9hbmdsZSk7XG4gICAgICAgICAgICB1bmJpbmRNb3ZlKCk7XG4gICAgICAgICAgICB1bmJpbmRTdG9wKCk7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgaW5lcnRpYV9pbnRlcnZhbCA9IGZhbHNlO1xuICAgICAgICB2YXIgaW5lcnRpYV9wb3dlciA9IDA7XG5cbiAgICAgICAgZnVuY3Rpb24gc3RhcnRJbmVydGlhKHBvd2VyKSB7XG4gICAgICAgICAgICBpbmVydGlhX3Bvd2VyID0gcG93ZXI7XG5cbiAgICAgICAgICAgIGluZXJ0aWFfaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChwcm9jZXNzSW5lcnRpYSwgMjApXG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0luZXJ0aWEoKSB7XG4gICAgICAgICAgICBjdXJfYW5nbGUgKz0gaW5lcnRpYV9wb3dlcjtcbiAgICAgICAgICAgIHJvdGF0ZShjdXJfYW5nbGUpO1xuXG4gICAgICAgICAgICBpbmVydGlhX3Bvd2VyIC89IDEuMDc7XG4gICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW5lcnRpYV9wb3dlcikgPCAuMSlcbiAgICAgICAgICAgICAgICBzdG9wSW5lcnRpYSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gc3RvcEluZXJ0aWEoKSB7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKGluZXJ0aWFfaW50ZXJ2YWwpO1xuICAgICAgICB9XG5cblxuICAgIC8vLy8gQklORElORyBGVU5DVElPTlNcblxuICAgICAgICBmdW5jdGlvbiBiaW5kU3RhcnQoKXtcbiAgICAgICAgICAgIHBhcmFtcy5oYW5kbGUub24oJ21vdXNlZG93bicsIGRyYWdTdGFydCk7XG4gICAgICAgICAgICBwYXJhbXMuaGFuZGxlWzBdLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBkcmFnU3RhcnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gdW5iaW5kU3RhcnQoKXtcbiAgICAgICAgICAgIHBhcmFtcy5oYW5kbGUub2ZmKCdtb3VzZWRvd24nLCBkcmFnU3RhcnQpO1xuICAgICAgICAgICAgcGFyYW1zLmhhbmRsZVswXS5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgZHJhZ1N0YXJ0KTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgZnVuY3Rpb24gYmluZE1vdmUoKXtcbiAgICAgICAgICAgIGpxX2JvZHkub24oJ21vdXNlbW92ZScsIGRyYWdNb3ZlKTtcbiAgICAgICAgICAgIGpxX2JvZHlbMF0uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgZHJhZ01vdmUpO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gdW5iaW5kTW92ZSgpe1xuICAgICAgICAgICAganFfYm9keS5vZmYoJ21vdXNlbW92ZScsIGRyYWdNb3ZlKTtcbiAgICAgICAgICAgIGpxX2JvZHlbMF0ucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgZHJhZ01vdmUpO1xuICAgICAgICB9XG5cblxuICAgICAgICBmdW5jdGlvbiBiaW5kU3RvcCgpe1xuICAgICAgICAgICAganFfYm9keS5vbignbW91c2V1cCcsIGRyYWdTdG9wKTtcbiAgICAgICAgICAgIGpxX2JvZHkub24oJ21vdXNlbGVhdmUnLCBkcmFnU3RvcCk7XG4gICAgICAgICAgICBqcV9ib2R5Lm9uKCd0b3VjaGVuZCcsIGRyYWdTdG9wKTtcbiAgICAgICAgICAgIGpxX2JvZHkub24oJ3RvdWNoY2FuY2VsJywgZHJhZ1N0b3ApO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gdW5iaW5kU3RvcCgpe1xuICAgICAgICAgICAganFfYm9keS5vZmYoJ21vdXNldXAnLCBkcmFnU3RvcCk7XG4gICAgICAgICAgICBqcV9ib2R5Lm9mZignbW91c2VsZWF2ZScsIGRyYWdTdG9wKTtcbiAgICAgICAgICAgIGpxX2JvZHkub2ZmKCd0b3VjaGVuZCcsIGRyYWdTdG9wKTtcbiAgICAgICAgICAgIGpxX2JvZHkub2ZmKCd0b3VjaGNhbmNlbCcsIGRyYWdTdG9wKTtcbiAgICAgICAgfVxuXG5cblxuICAgIC8vLy8gSU5JVFxuXG4gICAgICAgIGJpbmRTdGFydCgpO1xuICAgIH07XG5cblxufSggalF1ZXJ5ICkpOyIsIi8qIVxuICogU2Nyb2xsIExvY2sgdjEuMS4xXG4gKiBodHRwczovL2dpdGh1Yi5jb20vTW9oYW1tYWRZb3VuZXMvanF1ZXJ5LXNjcm9sbExvY2tcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTQgTW9oYW1tYWQgWW91bmVzXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuXG4gKi9cbihmdW5jdGlvbihuKXt0eXBlb2YgZGVmaW5lPT1cImZ1bmN0aW9uXCImJmRlZmluZS5hbWQ/ZGVmaW5lKFtcImpxdWVyeVwiXSxuKTpuKGpRdWVyeSl9KShmdW5jdGlvbihuKXtmdW5jdGlvbiB1KG4pe3ZhciB0PW4ucHJvcChcImNsaWVudFdpZHRoXCIpLGk9bi5wcm9wKFwib2Zmc2V0V2lkdGhcIikscj1wYXJzZUludChuLmNzcyhcImJvcmRlci1yaWdodC13aWR0aFwiKSwxMCksdT1wYXJzZUludChuLmNzcyhcImJvcmRlci1sZWZ0LXdpZHRoXCIpLDEwKTtyZXR1cm4gdCt1K3I8aX12YXIgaT1cIm9ubW91c2V3aGVlbFwiaW4gd2luZG93P1wiQWN0aXZlWE9iamVjdFwiaW4gd2luZG93P1wid2hlZWxcIjpcIm1vdXNld2hlZWxcIjpcIkRPTU1vdXNlU2Nyb2xsXCIsdD1cIi5zY3JvbGxMb2NrXCIscj1uLmZuLnNjcm9sbExvY2s7bi5mbi5zY3JvbGxMb2NrPWZ1bmN0aW9uKHIsZixlKXtyZXR1cm4gdHlwZW9mIGYhPVwic3RyaW5nXCImJihmPW51bGwpLChyPT09dW5kZWZpbmVkfHxyKSYmciE9PVwib2ZmXCI/dGhpcy5lYWNoKGZ1bmN0aW9uKCl7bih0aGlzKS5vbihpK3QsZixmdW5jdGlvbih0KXt2YXIgaSxzO2lmKCF0LmN0cmxLZXkmJihpPW4odGhpcyksZT09PSEwfHx1KGkpKSl7dC5zdG9wUHJvcGFnYXRpb24oKTt2YXIgZj1pLnNjcm9sbFRvcCgpLGg9aS5wcm9wKFwic2Nyb2xsSGVpZ2h0XCIpLGM9aS5wcm9wKFwiY2xpZW50SGVpZ2h0XCIpLG89dC5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGF8fC0xKnQub3JpZ2luYWxFdmVudC5kZXRhaWx8fC0xKnQub3JpZ2luYWxFdmVudC5kZWx0YVkscj0wO3QudHlwZT09PVwid2hlZWxcIiYmKHM9aS5oZWlnaHQoKS9uKHdpbmRvdykuaGVpZ2h0KCkscj10Lm9yaWdpbmFsRXZlbnQuZGVsdGFZKnMpOyhvPjAmJmYrcjw9MHx8bzwwJiZmK3I+PWgtYykmJih0LnByZXZlbnREZWZhdWx0KCksciYmaS5zY3JvbGxUb3AoZityKSl9fSl9KTp0aGlzLmVhY2goZnVuY3Rpb24oKXtuKHRoaXMpLm9mZih0KX0pfTtuLmZuLnNjcm9sbExvY2subm9Db25mbGljdD1mdW5jdGlvbigpe3JldHVybiBuLmZuLnNjcm9sbExvY2s9cix0aGlzfX0pO1xuLypcblxuKi8iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
